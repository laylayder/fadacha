<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è³ªæŠ¼ç¶­æŒç‡è¨ˆç®—</title>

    <link rel="icon" href="./icon.png" type="image/png" sizes="192x192">
    <link rel="apple-touch-icon" href="./icon.png" sizes="180x180">

    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* èƒŒæ™¯ */
        body { background-color: #111827; color: #f3f4f6; overflow-x: hidden; }
        /* å¡ç‰‡ */
        .card{ 
            background: #1f2937; border: 1px solid #374151; 
            border-radius: 12px; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5); 
        }
        
        /* è¼¸å…¥æ¡†æ¨£å¼ */
        input { 
        background-color: #374151 !important; 
        border-color: #4b5563 !important; 
        color: white !important; 
        text-transform: uppercase; /* é€™è¡Œæœƒè®“è¼¸å…¥çš„è‹±æ–‡è‡ªå‹•é¡¯ç¤ºç‚ºå¤§å¯« */
        }
        input:focus { border-color: #3b82f6 !important; ring: 2px #3b82f6; }
        
        /* å´é‚Šæ¬„éæ¸¡æ•ˆæœ */
        #logSidebar { transition: transform 0.3s ease-in-out; }
        
        /* è‚¡ç¥¨ä»£ç¢¼å¤§å°å¯«è½‰æ› */
        #stockName {
        text-transform: uppercase;}
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-2xl mx-auto">
        <div class="flex justify-center items-center gap-2 mb-2">
            <h1 class="text-2xl font-bold text-blue-400 text-center">è³ªæŠ¼ç™¼å¤§è²¡å£“åŠ›æ¸¬è©¦è¨ˆç®—æ©ŸV2.1</h1>
            <button onclick="toggleLog(true)" class="text-xs bg-gray-700 hover:bg-gray-600 text-gray-300 px-2 py-1 rounded border border-gray-500">
                æ›´æ–°ç´€éŒ„
            </button>
        </div>
        <h2 class="text-xl font-bold text-blue-400 mb-6 text-center">è‡ªå‹•å–åƒ¹å¾…é–‹ç™¼ å¤œç­ç´¯ç´¯</h2>
        <h2 class="text-xl font-bold text-blue-400 mb-6 text-center">æ­å°å°±å°äº† ä¿¡å¿ƒå–Šè©±</h2>
        
        <div class="card p-6 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="relative">
                    <label class="block text-sm font-medium text-blue-300">è‚¡ç¥¨ä»£ç¢¼</label>
                    <div class="flex mt-1">
                        <input type="text" id="stockName" value="006208" inputmode="text" 
                               class="block w-full border border-gray-300 rounded-l-md p-2 focus:ring-blue-500 focus:border-blue-500"
                               onclick="this.select()">
                        <button onclick="fetchPrice(true)" id="fetchBtn" 
                                class="bg-blue-600 hover:bg-blue-700 text-white px-3 rounded-r-md text-sm transition-all flex items-center active:scale-95 whitespace-nowrap shrink-0">
                            ç¾åƒ¹
                        </button>
                    </div>
                    <p id="statusMsg" class="text-xs mt-1 text-blue-400">è¼¸å…¥ä»£ç¢¼å¾Œé»æ“ŠæŠ“å–</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-blue-300">æŒæœ‰å¼µæ•¸ (å¼µ)</label>
                    <input type="number" id="shares" value="5" inputmode="numeric" pattern="[0-9]*" class="mt-1 block w-full border border-gray-300 rounded-md p-2" onclick="this.select()">
                </div>
                <div>
                    <label class="block text-sm font-medium text-blue-300">ç•¶å‰è‚¡åƒ¹ (å…ƒ)</label>
                    <input type="number" id="price" value="170" step="0.1" inputmode="decimal" class="mt-1 block w-full border border-gray-300 rounded-md p-2" onclick="this.select()">
                </div>
                <div>
                    <label class="block text-sm font-medium text-blue-300">å€Ÿæ¬¾é‡‘é¡ éœ€å°æ–¼å¸‚å€¼å…­æˆ(è¬å…ƒ)</label>
                    <input type="number" id="loanWan" value="20" inputmode="numeric" class="mt-1 block w-full border border-gray-300 rounded-md p-2" onclick="this.select()">
                </div>
                <div>
                    <label class="block text-sm font-medium text-blue-300">å€Ÿæ¬¾åˆ©ç‡ (%)</label>
                    <input type="number" id="rate" value="2.48" step="0.01" inputmode="decimal" class="mt-1 block w-full border border-gray-300 rounded-md p-2" onclick="this.select()">
                </div>
                <div>
                    <label class="block text-sm font-medium text-blue-300">æœ€ä½ç¶­æŒç‡ (%)</label>
                    <input type="number" id="threshold" value="140" inputmode="numeric" class="mt-1 block w-full border border-gray-300 rounded-md p-2" onclick="this.select()">
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="card p-4 text-center">
                <p class="text-sm text-blue-500">ç•¶å‰ç¸½å¸‚å€¼</p>
                <p id="resMarketValue" class="text-xl font-bold text-blue-600">NT$ 0</p>
            </div>
            <div class="card p-4 text-center">
                <p class="text-sm text-blue-500">ç•¶å‰ç¶­æŒç‡</p>
                <p id="resRatio" class="text-xl font-bold text-green-600">0%</p>
            </div>
            <div class="card p-4 text-center">
                <p class="text-sm text-blue-500">å¹´åˆ©æ¯è²»ç”¨</p>
                <p id="resInterest" class="text-xl font-bold text-orange-600">NT$ 0</p>
            </div>
            <div class="card p-4 border-2 border-red-200 text-center">
                <p class="text-sm text-blue-500 text-red-500 font-bold">æ‰€éœ€æœ€ä½è‚¡åƒ¹ (ç¶­æŒç‡ä¸‹é™)</p>
                <p id="resCallPrice" class="text-2xl font-black text-red-600">NT$ 0</p>
            </div>
        </div>

        <div class="mt-6">
            <button onclick="showGuide()" class="w-full bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 rounded-xl transition-all flex items-center justify-center gap-2 border border-gray-500 shadow-lg active:scale-95">
                ğŸ“² åˆ†äº« / å®‰è£è‡³æ¡Œé¢
            </button>
        </div>

        <div class="mt-6 text-xs text-gray-400 text-center space-y-1">
            <p>* æ•¸æ“šä¾†æºï¼šFinMind é–‹æ”¾ API (æ”¶ç›¤åƒ¹ç‚ºæº–) </p>
            <p>*æä¸å®š æ”¹å¤©è©¦è©¦çœ‹ ç´¯ç´¯*</p>
            <p>* ä¸‹æµ·å¹¹æ´»åƒ¹å…¬å¼ï¼š(å€Ÿæ¬¾é‡‘é¡ Ã— ç¶­æŒç‡ä¸‹é™) Ã· è‚¡æ•¸</p>
            <p>* è´äº†æœƒé¤¨å«©æ¨¡ è¼¸äº†ä¸‹æµ·å¹¹æ´» *</p>
        </div>
    </div>

    <div id="logOverlay" class="fixed inset-0 bg-black/60 z-40 hidden" onclick="toggleLog(false)"></div>
    <div id="logSidebar" class="fixed top-0 right-0 w-64 h-full bg-[#1f2937] z-50 p-6 shadow-2xl transform translate-x-full border-l border-gray-700">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-xl font-bold text-blue-400">æ›´æ–°ç´€éŒ„</h3>
            <button onclick="toggleLog(false)" class="text-gray-400 text-2xl">&times;</button>
        </div>
        <div class="space-y-6 overflow-y-auto h-[90%]">
            <div class="border-l-2 border-blue-500 pl-4">
                <p class="text-sm font-bold text-white">V2.1 (æœ€æ–°)</p>
                <p class="text-xs text-gray-400 mt-1">â— æ–°å¢æ›´æ–°ç´€éŒ„</p>
                <p class="text-xs text-gray-400 ">â— è‚¡ç¥¨ä»£è™ŸR L æœƒè‡ªå‹•è®Šå¤§å¯«</p>
                <p class="text-xs text-gray-400 ">â— åŸæœ¬é è¨­æ•¸å­—éµ æ‰‹æ©Ÿæœƒä¸èƒ½æ‰“è‹±æ–‡ æ”¹ç‚ºæ–‡å­—éµ</p>
                
            </div>
            <div class="border-l-2 border-gray-600 pl-4">
                <p class="text-sm font-bold text-gray-300">V2.0</p>
                <p class="text-xs text-gray-400 mt-1">â— å¢åŠ åˆ†äº«åŠŸèƒ½ å‡è£è‡ªå·±æ˜¯App</p>
                <p class="text-xs text-gray-400">â— åŠ å…¥è‡ªå‹•è¨ˆç®—å…­æˆå€Ÿæ¬¾é‚è¼¯</p>
                <p class="text-xs text-gray-400">â— æ”¹æˆå¼µä¾†è¨ˆç®— è³ªæŠ¼ä¸èƒ½ç”¨é›¶è‚¡</p>
                <p class="text-xs text-gray-400">â— ä¿®æ­£å¼µæ•¸(1000è‚¡)æ›ç®—å…¬å¼</p>
            </div>
            <div class="border-l-2 border-gray-600 pl-4">
                <p class="text-sm font-bold text-gray-300">V1.5</p>
                <p class="text-xs text-gray-400 mt-1">ä¸²æ¥ FinMind API æŠ“è‚¡åƒ¹ æ™‚å¥½æ™‚å£ è·Ÿäººç”Ÿä¸€æ¨£</p>
                <p class="text-xs text-gray-400">æ”¹æˆæ·±è‰²æ¨¡å¼ä»‹é¢ äººç”Ÿé»˜é»˜çš„ç™¼å¤§è²¡</p>
                <p class="text-xs text-gray-400">æœ‰AIå¹«å¿™æ’ç‰ˆ çœŸæ–¹ä¾¿ å¸Œæœ›AIå¹«æˆ‘è³ºå¤§éŒ¢</p>
            </div>
        </div>
    </div>

    <div id="guideModal" class="fixed inset-0 flex items-center justify-center z-50 hidden p-6" onclick="this.classList.add('hidden')">
        <div class="card p-8 max-w-sm w-full text-center space-y-4" onclick="event.stopPropagation()">
            <h3 class="text-xl font-bold text-blue-400">å®‰è£æ•™å­¸</h3>
            <div class="text-left space-y-4 text-sm text-gray-300">
                <p><strong>iPhone (Safari):</strong><br>é»æ“Šç€è¦½å™¨ä¸‹æ–¹ <span class="text-blue-400">ã€Œåˆ†äº«ç®­é ­ã€</span>ï¼Œé¸ <span class="text-white font-bold">ã€ŒåŠ å…¥ä¸»ç•«é¢ã€</span>ã€‚</p>
                <hr class="border-gray-700">
                <p><strong>Android (Chrome):</strong><br>é»æ“Šå³ä¸Šè§’ <span class="text-blue-400">ã€Œä¸‰å€‹é»ã€</span>ï¼Œé¸ <span class="text-white font-bold">ã€Œå®‰è£æ‡‰ç”¨ç¨‹å¼ã€</span> æˆ–æ–°å¢è‡³ä¸»ç•«é¢ã€‚</p>
            </div>
            <button onclick="document.getElementById('guideModal').classList.add('hidden')" class="w-full bg-blue-600 text-white py-2 rounded-lg mt-4 font-bold">æˆ‘çŸ¥é“äº†</button>
        </div>
    </div>

    <script>
        const inputs = ['shares', 'price', 'loanWan', 'rate', 'threshold'];
        
        /* æ ¸å¿ƒè¨ˆç®—åŠŸèƒ½*/
        function calculate(autoUpdateLoan = false) {
            //å¼µæ•¸ 
            const shares = parseFloat(document.getElementById('shares').value) || 0;
            //è‚¡åƒ¹ 
            const price = parseFloat(document.getElementById('price').value) || 0;
            
            //å¸‚å€¼ (1å¼µ = 1000è‚¡)
            const marketValue = shares * price * 1000;

            // --- æ–°å¢ï¼šè‡ªå‹•è¨ˆç®—å…­æˆå€Ÿæ¬¾é‡‘é¡ ---
            if (autoUpdateLoan === true) {
                const sixtyPercent = Math.floor((marketValue * 0.6) / 10000);
                document.getElementById('loanWan').value = sixtyPercent;
            }

            //å€Ÿè²¸ç¸½é¡ 
            const loan = (parseFloat(document.getElementById('loanWan').value) || 0) * 10000;
            //è²¸æ¬¾åˆ©ç‡ 
            const rate = parseFloat(document.getElementById('rate').value) || 0; //è²¸æ¬¾åˆ©ç‡
            //ç¶­æŒç‡
            const threshold = (parseFloat(document.getElementById('threshold').value) || 0) / 100; 

            //å€Ÿè²¸æ¯”ä¾‹ (ç¶­æŒç‡)
            const ratio = loan > 0 ? (marketValue / loan) * 100 : 0;
            //åˆ©æ¯ 
            const interest = loan * (rate / 100);
            
            //æ‰€éœ€æœ€ä½åƒ¹ (ä¿®æ­£å…¬å¼ï¼šéœ€è€ƒæ…® 1000 è‚¡ç‚ºä¸€å¼µ)
            const callPrice = (shares > 0 && loan > 0) ? (loan * threshold) / (shares * 1000) : 0; 

            //ç•¶å‰å¸‚å€¼ Math.round(marketValue) å››æ¨äº”å…¥
            document.getElementById('resMarketValue').innerText = `NT$ ${Math.round(marketValue).toLocaleString()}`;
            //ç•¶å‰ç¶­æŒç‡
            document.getElementById('resRatio').innerText = `${ratio.toFixed(2)}%`;
            //å¹´åˆ©æ¯
            document.getElementById('resInterest').innerText = `NT$ ${Math.round(interest).toLocaleString()}`;
            //æ‰€éœ€æœ€ä½åƒ¹
            document.getElementById('resCallPrice').innerText = `NT$ ${callPrice.toFixed(2)}`;

            const ratioEl = document.getElementById('resRatio');
            if (ratio < 140) {
                ratioEl.className = "text-xl font-bold text-red-600";
            } else if (ratio < 160) {
                ratioEl.className = "text-xl font-bold text-yellow-600";
            } else {
                ratioEl.className = "text-xl font-bold text-green-600";
            }
        }

        // è‡ªå‹•å–åƒ¹åŠŸèƒ½
        async function fetchPrice(updateLoan = false) {
            // .toUpperCase() è‹±æ–‡è½‰å¤§å¯«
            const stockId = document.getElementById('stockName').value.trim().toUpperCase();
    
            // æŠŠè½‰å®Œå¤§å¯«çš„å­—å†å¡å›å»
            document.getElementById('stockName').value = stockId;
            const btn = document.getElementById('fetchBtn');
            const status = document.getElementById('statusMsg');
    
    if (!stockId) return alert('è«‹è¼¸å…¥è‚¡ç¥¨ä»£ç¢¼');

            

            btn.disabled = true;
            btn.innerText = 'è®€å–ä¸­...';
            status.innerText = 'é€£ç·šè‡³ FinMind API...';

            try {
                const today = new Date().toISOString().split('T')[0];
                const url = `https://api.finmindtrade.com/api/v4/data?dataset=TaiwanStockPrice&data_id=${stockId}&start_date=${today}`;
                
                const response = await fetch(url);
                const data = await response.json();

                if (data.data && data.data.length > 0) {
                    const lastData = data.data[data.data.length - 1];
                    const closePrice = lastData.close;
                    
                    document.getElementById('price').value = closePrice;
                    status.innerText = `æˆåŠŸæŠ“å–ï¼š${stockId} åƒ¹æ ¼ç‚º ${closePrice}`;
                    status.className = "text-xs mt-1 text-blue-500 font-bold";
                    
                    // æŠ“å–æˆåŠŸå¾Œï¼ŒåŸ·è¡Œè¨ˆç®—ä¸¦æ›´æ–°å…­æˆå€Ÿæ¬¾
                    calculate(updateLoan);
                } else {
                    status.innerText = 'æŸ¥ç„¡ä»Šæ—¥æ•¸æ“šï¼Œè«‹æ‰‹å‹•æ›´æ–°æˆ–ç¢ºèªä»£ç¢¼';
                    status.className = "text-xs mt-1 text-red-500";
                }
            } catch (error) {
                console.error(error);
                status.innerText = 'æŠ“å–å¤±æ•—ï¼Œè«‹ç¢ºèªä»£ç¢¼æˆ–ç¶²è·¯';
                status.className = "text-xs mt-1 text-red-500";
            } finally {
                btn.disabled = false;
                btn.innerText = 'ç¾åƒ¹';
            }
        }

        // æ§åˆ¶æ›´æ–°ç´€éŒ„é–‹é—œ
        function toggleLog(show) {
            const sidebar = document.getElementById('logSidebar');
            const overlay = document.getElementById('logOverlay');
            if (show) {
                sidebar.classList.remove('translate-x-full');
                overlay.classList.remove('hidden');
            } else {
                sidebar.classList.add('translate-x-full');
                overlay.classList.add('hidden');
            }
        }

        // åˆ†äº«å¼•å°åŠŸèƒ½
        function showGuide() {
            if (navigator.share) {
                navigator.share({
                    title: 'è³ªæŠ¼ç™¼å¤§è²¡è¨ˆç®—æ©Ÿ',
                    text: 'è´äº†æœƒé¤¨å«©æ¨¡ï¼Œè¼¸äº†ä¸‹æµ·å¹¹æ´»ï¼',
                    url: window.location.href
                }).catch(() => {
                    document.getElementById('guideModal').classList.remove('hidden');
                });
            } else {
                document.getElementById('guideModal').classList.remove('hidden');
            }
        }

        // è‡ªå‹•è¨ˆç®—
        inputs.forEach(id => {
            document.getElementById(id).addEventListener('input', () => calculate(false));
        });

        // åˆå§‹åŒ– (é–‹å•Ÿç¶²é æ™‚å…ˆç®—ä¸€æ¬¡å…­æˆ)
        calculate(true);
    </script>
</body>
</html>